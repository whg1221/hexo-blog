---
title: 公司中台页面生产发布问题复盘
date: 2021-12-10 18:00:00
categories:
  - essay
tags:
---
> 老代码遗留问题+绝对路径调用接口+生产环境特殊判断=出问题 —— 沃兹基硕德

代码发布当天，正好约了浦东工作的同学来公司楼下吃饭。正式发布到生产环境前，想着没啥大事，测试环境都过了好几遍了，暗戳戳下去吃饭了。刚点完餐产品、测试直接call手机，说出事了，页面白屏，紧急召回看问题orz

（被同学疯狂嘲笑：你这个岗位很忙啊。。。

# 问题回顾

公司中台项目原本没有引入公司配置工具框架，本次项目改动阶段，产品新增需求需要引入配置开关控制页面元素展示。

技术方案上引用了另一个项目的相关代码，绝对路径调用配置框架接口地址获取配置，测试环境通过。

生产环境上线后，配置框架接口绝对路径被前置拼接了页面自身domain，导致页面出现js 404报错。

# 当天临时补救措施

删除了配置框架接口的调用，暂时在代码层面开关全关，待后期探明问题后重新将改进代码上线。

# 问题复盘

经检查，发现为BaseController中的fetch方法内if判读条件引起的问题。

高亮条件判断永远是true，且只在生产环境暴露此问题。

![image1](/images/essay/003/image1.png)

（这个git blame纯属因为新同事beautify了整个项目的代码，直接把前人的commit，blame到他身上了。。。

# 教训总结

引入新的feature需要对全流程环境代码进行把控。

警惕代码中区分环境的分支语句，可能会使问题隐藏至生产环境爆雷。

谨慎优化代码格式，会使问题追溯过程变得微妙。。。