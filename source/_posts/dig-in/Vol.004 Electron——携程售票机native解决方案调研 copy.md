---
title: Electron——携程售票机native解决方案调研
date: 2020-11-13 18:00:00
categories:
  - dig-in
tags:
  - electron
---
# 一、Electron简述

Electron（原名为Atom Shell）是GitHub开发的一个开源框架。它允许使用Node.js（作为后端）和Chromium（作为前端）完成桌面GUI应用程序的开发。

- Web技术：Electron 基于 Chromium 和 Node.js, 让你可以使用 HTML, CSS 和 JavaScript 构建应用。
- 开源：Electron 是一个由 GitHub 及众多贡献者组成的活跃社区共同维护的开源项目。
- 跨平台：Electron 兼容 Mac、Windows 和 Linux，可以构建出三个平台的应用程序。

# 二、售票机系统结构图

![售票机系统结构图](/images/dig-in/004/image1.png)

# 三、Native主要功能点&硬件

## 主要功能点

1. ### 获取硬件信息，进行token加密

   售票机与RESTful通信需要提供一台机器唯一的密钥，目前是通过“各硬件id+设备id号”进行sha1加密得到的，理论上唯一的“设备id号”就能保证生成的token唯一。Electron取不到诸如CPUid之类细粒度的数据，所以双方token协议需要一起修改。

2. ### 硬件设备调用

   主要驱动三种硬件设备：身份证读取设备，扫码设备，打印机。

   身份证读取设备分USB驱动和串口驱动 扫码设备分USB免驱和串口驱动。

   打印机走统一打印协议，但需要自行维护打印模板。

3. ### Clog/本地 日志

   Nodejs层可以实现clog日志的记录 本地日志需要读写本地文件。

4. ### 软件升级

   Electron有充足的解决方案，可以实现增量/全量更新。但更新方法的变更可能需要配置后台变更升级包的部署方式。



## 硬件设备

- 身份证读取设备

  USB设备，通过webSocket实现数据通信；

  串口设备，使用serial-port npm插件实现数据通信。

- 扫码设备

  USB设备，等同于USB键盘；

  串口设备，使用serial-port npm插件实现数据通信。

# 四、优缺点总结

## 改动点

1. ### 硬件设备的调用

   原计划采用ffi/edge调用各硬件驱动dll文件，学习成本较高。可以通过对硬件进行分类，对于串口设备使用serial-port中间件完成数据通信。对于打印机设备，区分不同打印纸张，使用不同的html打印模板，调用系统打印服务进行打印，以及打印队列的监听。

2. ### native日志，升级功能

   native日志的迁移比较细碎。Electron升级方式的改变，可能需要牵扯到后台配置页面的配合变更。

3. ### token加密方式的变更

   由于无法获取到细粒度的硬件id数据，设备注册、以及接口交互时所用的token生成方式需要变更。必然会牵扯到RESTful接口的改动。

## 优缺点分析

### 优点

1. 有助于后续新硬件接入等需要变更native代码的情况下，升级native程序。
2. 有助于售票机全流程的把控，软硬件问题方便定位处理。

### 缺点

1. 没有新增需求的情况下迁移成本较大，试运行阶段流程上可能会出现一些bug。
2. 对于硬件调用的认知相对比较粗浅，出问题无法准确定位是硬件问题还是中间件问题。
3. 需要接口、配置后台同步进行改动，灰度试运行的话兼容代码是个问题。